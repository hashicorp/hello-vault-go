version: "3.9"
services:
  api:
    build: .
    environment:
      SERVER_PORT: "8080"
      DB_HOST: "db"
      SECURE_API_ADDRESS: "http://secureAPI/api"
      SECRET_ID: "df56e71d-75a0-f245-d91e-7ccfcc1d936d"
      APPROLE_ROLE_ID: "ce80d2ac-e517-9564-8460-b405edf2fd28"
      VAULT_ADDRESS: "http://vault:8200"
    ports:
      - "8080:8080"
    depends_on:
      - db
      - vault
      - secureAPI

  db:
    image: postgres:14.0
    restart: always
    environment:
      POSTGRES_PASSWORD: rootpassword
    volumes:
      - "dbdata:/var/lib/postgresql/data"
      - "./setup/db-scripts:/docker-entrypoint-initdb.d/"
    ports:
      - "5432:5432"

  vault:
    image: vault:latest
    volumes:
      - "vaultdata:/vault/file"
      - "./setup/vault-server:/vault/config"
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    command:
      - "server"

  # secureAPI is a simulated 3rd party server that requires a specific header to get a 200 response
  secureAPI:
    image: nginx:latest
    volumes:
      - "./setup/nginx/default.conf.template:/etc/nginx/templates/default.conf.template"
    ports:
      - "1717:80"
    environment:
      # API_KEY sets the expected value for incoming requests' header X-API-KEY
      API_KEY: HelloWorld

volumes:
  dbdata:
  vaultdata:
